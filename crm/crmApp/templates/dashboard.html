{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
    .fas.fa-money-bill-alt {
        font-size: 1.7rem;
        margin-top: 10px;
    }


</style>
<!-- Chart.js Script -->

<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/Chart.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom mb-5">
    <div class="container-fluid">

        <!-- Navbar Brand and Description -->
        <div class="container" style="width: 100%;">
            <a class="navbar-brand" href="#"> <b>Welcome to your dashboard</b></a>
            <p>This is where you can manage your tasks and view important information.</p>
        </div>

        <!-- Navbar Toggler Button -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Navbar Links -->
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <img src="{% static 'assets/search.png' %}" class="" alt="search">
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <img src="{% static 'assets/message.png' %}" class="" alt="message">
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <img src="{% static 'assets/noti.png' %}" class="" alt="notification">
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <img src="{% static 'assets/setting.png' %}" class="" alt="total-users">
                    </a>
                </li>
                <li class="nav-item" style="margin-top: 3%; border: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#3180ff';" onmouseout="this.style.backgroundColor='#f3f6fb';">
                    {% if request.session.userN %}
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle fa-lg"></i>
                        <p class="mb-0 ml-2 px-2" style="font-weight: bold; font-size: large;">{{ request.session.userN }}</p>
                    </div>
                    {% endif %}
                </li>
            </ul>
        </div>
    </div>
</nav>

<div id="notificationModal" class="modal border" style="display: none; position: absolute; top: 100px; left: 0; height: auto; width: 25rem">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Notification</h5>
                <button type="button" class="btn-close" onclick="hideNotification()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <tbody>
                        {% for chargeback in pending_chargebacks %}
                        <tr style="font-size: 0.7rem">
                            <td>{{ chargeback.Booking }}</td>
                            <td>{{ chargeback.booking_confirmation_no }}</td>
                            <td>{{ chargeback.chargeback_amount }}</td>0
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
</div>



{% for chargeback in pending_chargebacks %}
<span class="position-relative" style="cursor: pointer" onclick="showNotification('{{ forloop.counter }}')">
    <i class="fas fa-money-bill-alt"></i>
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-light text-dark mt-1">
        {{ forloop.counter }}
    </span>
</span>
{% endfor %}


<!-- Display Chargeback Alerts -->
    <marquee behavior="scroll" direction="left" class="alert alert-warning"{% if pending_chargebacks %} style="display:block;" {% else %} style="display:none;" {% endif %}>
        {% for chargeback in pending_chargebacks %}
           <Strong>Chargeback alert:</strong> {{ chargeback.Booking.passenger_name }} - ${{ chargeback.Booking.price }} | {{ chargeback.chargeback_received_date }}
        {% endfor %}
    </marquee>
    <!-- <h1 class="text-center mt-1 py-2 col-custom-color2">CRM  <span>Dash</span>board</h1> <br> -->
    <div class="container" style="padding-right: 0; padding-left: 0;">
        <div class="row">
            <div class="col-md-3 px-1 mt-md-0">
                <div class="card shadow-lg col-custom-color card-with-background">
                    <div class="card-body">
                        {% if request.user.is_superuser %}
                            <a class="text-decoration-none text-reset" href="{% url 'crmApp:sales' %}">
                        {% endif %}
                        <h5 class="card-text" style="color: #fff; padding-right: 50%;">Total Sales</h5>
                        </a>
                        <div class="container mt-5">
                            <div class="row">
                                <div class="col text-left d-flex align-items-center">
                                    <h3><b>${{ total_sales }}</b></h3>
                                </div>
                                <div class="col text-right">
                                    <div class="up text-center" style="background-color: rgba(171, 233, 171, 0.5);">
                                        <h5>up</h5>
                                       
                                    </div>
                                    <p class="mb-0" style="font-size: 0.5rem;">Since last Month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 px-1 mt-md-0 mt-1">
                <div class="card shadow-lg col-custom-color card-with-background3">
                    <div class="card-body">
                        <a class="text-decoration-none text-reset" href="{% url 'crmApp:sales' %}">
                            <h5 class="card-text" style="color: #fff; padding-right: 50%;">Total Leads</h5>
                        </a>
                        <div class="container mt-5">
                            <div class="row">
                                <div class="col text-left d-flex align-items-center">
                                    <h3><b>${{ total_sales }}</b></h3>
                                </div>
                                <div class="col text-right">
                                    <div class="up text-center" style="background-color: rgba(171, 233, 171, 0.5);">
                                        <h5>up</h5>
                                       
                                    </div>
                                    <p class="mb-0" style="font-size: 0.5rem;">Since last Month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 px-1 mt-md-0 mt-1">
                <div class="card shadow-lg col-custom-color card-with-background4">
                    <div class="card-body">
                        <a class="text-decoration-none text-reset" href="{% url 'crmApp:sales' %}">
                            <h5 class="card-text" style="color: #fff; padding-right: 30%;">Total Refund</h5>
                        </a>
                        <div class="container mt-5">
                            <div class="row">
                                <div class="col text-left d-flex align-items-center">
                                    <h3><b>${{ total_sales }}</b></h3>
                                </div>
                                <div class="col text-right">
                                    <div class="up text-center" style="background-color: rgba(171, 233, 171, 0.5);">
                                        <h5>up</h5>
                                       
                                    </div>
                                    <p class="mb-0" style="font-size: 0.5rem;">Since last Month</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 px-1 mt-md-0 mt-1">
                <div class="card shadow-lg col-custom-color card-with-background5">
                    <div class="card-body">
                        <a class="text-decoration-none text-reset" href="{% url 'crmApp:sales' %}">
                            <h5 class="card-text" style="color: #fff; padding-right: 10%;">Total Chargeback</h5>
                        </a>
                        <div class="container mt-5">
                            <div class="row">
                                <div class="col text-left d-flex align-items-center">
                                    <h3><b>${{ total_sales }}</b></h3>
                                </div>
                                <div class="col text-right">
                                    <div class="up text-center" style="background-color: rgba(171, 233, 171, 0.5);">
                                        <h5>up</h5>
                                       
                                    </div>
                                    <p class="mb-0" style="font-size: 0.5rem;">Since last Month</p>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
            
            
        </div>
    </div>
    
    <div class="container mt-4" style="padding-right: 0; padding-left: 0;" >
        <div class="row">
            <div class="col-md-6 px-1 mt-md-0">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Sales Overview</h3>
                        <div class="form-group">
                            <select>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>
    
            <div class="col-md-6 px-1 mt-md-0">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Income</h3>
                        <div class="form-group">
                            <select>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="chart-container income" style="position: relative; height: 100%; width: 100%; align-items: center;">
                            <canvas id="incomeChart"></canvas>
                        </div>
                </div>
            </div>
    
        </div>
    </div>
    
    <script>
// Sales Chart Data
var salesData = {
    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
    datasets: [{
        label: '', // Set an empty string to hide the legend label
        data: [1000, 2000, 1500, 3000, 2500, 1800, 4000],
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
    }]
};

// Render Charts
var salesCtx = document.getElementById('salesChart').getContext('2d');
var incomeCtx = document.getElementById('incomeChart').getContext('2d');

var salesChart = new Chart(salesCtx, {
    type: 'line',
    data: salesData,
    options: {
        legend: {
            display: false // Hide the legend
        }
    }
});






  // Income Chart Data
var incomeData = {
    labels: ['Profit', 'Income', 'Loss'],
    datasets: [{
        label: 'Income',
        data: [2500, 2000, 1800], // Adjusted income data for pie chart
        backgroundColor: [
            'rgba(255, 99, 132, 0.5)', // Red color for profit
            'rgba(54, 162, 235, 0.5)', // Blue color for income
            'rgba(255, 206, 86, 0.5)', // Yellow color for loss
        ],
        borderColor: [
            'rgba(255, 99, 132, 1)', // Red color for profit
            'rgba(54, 162, 235, 1)', // Blue color for income
            'rgba(255, 206, 86, 1)', // Yellow color for loss
        ],
        borderWidth: 1
    }]
};

// Initialize pie chart
var incomeChart = new Chart(incomeCtx, {
    type: 'pie', // Set chart type to pie
    data: incomeData,
    options: {
        legend: {
            position: 'bottom' // Display legend at the bottom
        },
        plugins: {
            labels: {
                render: 'label',
                fontColor: 'black',
                fontSize: 14,
                position: 'outside'
            }
        }
    }
});








    </script>
    
    
    
     <div class="container mt-4" style="padding-right: 0; padding-left: 0;">
        <div class="row">
            <div class="col-md-9 px-1 mt-md-0">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Total Sales</h5>
                        <button class="btn btn-sm btn-primary">View All</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Agent Name</th>
                                    <th>Total Sales</th>
                                    <th>Refund</th>
                                    <th>Chargeback</th>
                                    <th>Chargeback Alert</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Add your table rows here -->
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <!-- Add more rows if needed -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-3 ">
                <div class="card">
                    <div class="card-header">
                        <h5>Best Performers</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            
                            <tbody>
                                <!-- Add your table rows here -->
                                <tr>
                                    <td>Lwithw Jr Kacy</td>  
                                </tr>
                                <tr>
                                    <td>Timphu Senyung</td>
                                </tr>
                                <tr>
                                    <td>Danswrang Boro</td>
                                </tr>
                                <tr>
                                    <td>Bhaivab Singh</td>
                                </tr>
                                <tr>
                                    <td>Yo Yo Honey Singh</td>
                                </tr>
                                <!-- Add more rows if needed -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4" style="padding-right: 0; padding-left: 0;">
        <div class="row">
            <div class="col-md-12 px-1 mt-md-0">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>Income Overview</h3>
                        <div>
                            <button class="btn btn-sm btn-primary mr-2">Annual</button>
                            <button class="btn btn-sm btn-primary mr-2">Monthly</button>
                            <button class="btn btn-sm btn-primary ml-2">View More</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="incomeOverviewChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
       // Income Overview Chart Data
var incomeOverviewData = {
    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
    datasets: [{
        label: '', // Set an empty string to hide the legend label
        data: [2000, 2500, 1800, 3000, 2000, 1500, 2500, 2800, 2200, 3500, 2400, 2000], // Data for all months
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
        barThickness: 10 // Adjust the width of the bars here
    }]
};

// Render Chart
var incomeOverviewCtx = document.getElementById('incomeOverviewChart').getContext('2d');

var incomeOverviewChart = new Chart(incomeOverviewCtx, {
    type: 'bar',
    data: incomeOverviewData,
    options: {
        legend: {
            display: false // Hide the legend
        },
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        }
    }
});

    </script>
    


    <div class="container mt-4 mb-5" style="padding-right: 0; padding-left: 0;">
        <div class="row">
            <!-- Total Leads Bar Graph -->
            <div class="col-md-6 px-1 mt-md-0">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>Total Leads</h3>
                        <div class="form-group">
                            <select>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                            <button>View More</button>
                        </div>
                        
                        
                    </div>
                    <div class="card-body">
                        <!-- Placeholder for total leads bar graph -->
                        <canvas id="totalLeadsGraph"></canvas>
                    </div>
                </div>
            </div>
    
            <!-- Chargeback Ratio Circle Graph -->
            <div class="col-md-6 px-1 mt-md-0">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>Chargeback Ratio</h3>
                        <button class="btn btn-primary">View More</button>
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div class="chart-container" style="position: relative; height: 100%; width: 100%; align-items: center;">
                            <canvas id="chargebackRatioGraph"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
    </div>
    
    <!-- Total Leads Bar Graph -->
    <script>
        // Total Leads Data
            var totalLeadsCanvas = document.getElementById('totalLeadsGraph');
            var totalLeadsData = {
                labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
                datasets: [{
                    label: 'Total Leads',
                    data: [100, 200, 150, 300, 250, 400, 350],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)', // Blue color for bars
                    borderColor: 'rgba(54, 162, 235, 1)', // Border color for bars
                    borderWidth: 1,
                    barThickness: 10 // Define bar thickness here
                }]
            };

    
        // Total Leads Options
        var totalLeadsOptions = { 
            legend: {
            display: false // Hide the legend
        },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        };
    
        // Initialize Total Leads Bar Graph
        var totalLeadsChart = new Chart(totalLeadsCanvas, {
            type: 'bar',
            data: totalLeadsData,
            options: totalLeadsOptions
        });
    </script>
    
   <!-- Chargeback Ratio Circle Graph -->
   <script>
var xitems = ['Weekly', 'Monthly', 'Quarterly', 'Yearly'];
var yitems = [478, 522, 200, 300]; // Update with your desired data

new Chart(document.getElementById("chargebackRatioGraph"), {
    type: 'doughnut',
    data: {
        labels: xitems,
        datasets: [{
            data: yitems,
            backgroundColor: ["#8DB6CD", "#FFB6C1", "#87CEEB", "#FFD700"],
            fill: false
        }]
    },
    options: {
        tooltips: {
            enabled: false,
        },
        showPercentage: true,
        elements: {
            arc: {
                borderWidth: 1,
                borderRadius: 10, // Set border radius to 10
            }
        },
        legend: {
            display: true,
            position: 'bottom',
            labels: {
                fontColor: 'black', // Set label font color
                fontSize: 14, // Set label font size
                usePointStyle: true, // Use round icons
                padding: 20 // Set padding to 5
            }
        }
    }
});

Chart.pluginService.register({
    afterDraw: function(chart, easing) {
        if (chart.config.options.showPercentage || chart.config.options.showLabel) {
            var self = chart.config;
            var ctx = chart.chart.ctx;

            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "black"; // Change text color to black for better visibility
            ctx.font = 'bold 0.6rem Arial'; // Change font style and size

            self.data.datasets.forEach(function(dataset, datasetIndex) {
                var total = 0,
                    labelxy = [],
                    offset = Math.PI / 2,
                    radius,
                    centerx,
                    centery,
                    lastend = 0;

                for (var val of dataset.data) {
                    total += +val;
                }

                var i = 0;
                var meta = dataset._meta[i];
                while (!meta) {
                    i++;
                    meta = dataset._meta[i];
                }

                var element;
                for (index = 0; index < meta.data.length; index++) {
                    element = meta.data[index];
                    radius = 0.9 * element._view.outerRadius - element._view.innerRadius;
                    centerx = element._model.x;
                    centery = element._model.y;
                    var thispart = dataset.data[index];
                    var arcsector = Math.PI * (2 * thispart / total);
                    if (element.hasValue() && dataset.data[index] > 0) {
                        labelxy.push(lastend + arcsector / 2 + Math.PI + offset);
                    } else {
                        labelxy.push(-1);
                    }
                    lastend += arcsector;

                    // Apply border radius of 10 to each segment
                    element._model.borderRadius = 10;

                    // Check if label is 'Weekly' and apply border width of 15
                    if (chart.config.data.labels[index] === 'Weekly') {
                        element._model.borderWidth = 15;
                    }
                }

                var lradius = radius * 3 / 1.6;
                for (var idx in labelxy) {
                    if (labelxy[idx] === -1) continue;
                    var langle = labelxy[idx];
                    var dx = centerx + lradius * Math.cos(langle);
                    var dy = centery + lradius * Math.sin(langle);
                    var val = (dataset.data[idx] / total * 100).toFixed(1);

                    if (chart.config.options.showPercentage) {
                        ctx.fillText(val + '%', dx, dy);
                    }
                }
            });
        }
    }
});





</script>


    

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    {% comment %} <script>
        $(document).ready(function() {
            $('.agent-button').click(function(event) {
                event.preventDefault(); // Prevent the default form submission behavior
                var username = $(this).data('username'); // Get the username from the data attribute
                var csrftoken = $('[name=csrfmiddlewaretoken]').val(); // Get the CSRF token from the hidden input field
        
                $.ajax({
                    url: '/get_agent_data/',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken  // Include the CSRF token in the headers
                    },
                    data: {
                        username: username
                    },
                    success: function(response) {
                        console.log('Total Price:', response.total_price);
                        $('#t_sales').text('$ '+response.total_price);
                    },
                    error: function(xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        // Handle error response if needed
                    }
                });
            });
        });        
    </script> {% endcomment %}
    <script>
        $(document).ready(function() {
            // Perform AJAX request when the document is ready
            getAgentData();
    
            $('.agent-button').click(function(event) {
                event.preventDefault(); // Prevent the default form submission behavior
                getAgentData();
            });
    
            function getAgentData() {
                var username = $('.agent-button').data('username'); // Get the username from the data attribute
                var csrftoken = $('[name=csrfmiddlewaretoken]').val(); // Get the CSRF token from the hidden input field
    
                $.ajax({
                    url: '/get_agent_data/',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken  // Include the CSRF token in the headers
                    },
                    data: {
                        username: username
                    },
                    success: function(response) {
                        console.log('Total Price:', response.total_price);
                        $('#t_sales').text('$ ' + response.total_price);
                    },
                    error: function(xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        // Handle error response if needed
                    }
                });
            }
        });        
    </script>
    
     <!-- <script>
        // Get all list items with the class "clickable"
        var clickableItems = document.querySelectorAll('.clickable');
    
        // Loop through each clickable item and attach a click event listener
        clickableItems.forEach(function(item) {
            item.addEventListener('click', function() {
                // Log the text content of the clicked list item to the console
                console.log(item.textContent);
            });
        });
    </script>  -->
    <script>
        function showNotification(counter) {
            var modal = document.getElementById('notificationModal');
            var notificationContent = document.getElementById('notificationContent');
            
            // Update notification content
            //notificationContent.textContent = 'You clicked on chargeback #' + counter;
        
            // Show the modal by setting its display to 'block'
            modal.style.display = 'block';
            // Adjust modal position relative to the icon
            var iconPosition = document.querySelector('.position-relative').getBoundingClientRect();
            modal.style.top = (iconPosition.bottom + 10) + 'px';
            modal.style.left = (iconPosition.left) + 'px';
        }
        
        function hideNotification() {
            var modal = document.getElementById('notificationModal');
        
            // Hide the modal by setting its display to 'none'
            modal.style.display = 'none';
        }
            
    </script>
    


   
{% endblock %}
