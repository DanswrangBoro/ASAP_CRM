{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
    .fas.fa-money-bill-alt {
        font-size: 1.7rem;
        margin-top: 10px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom mb-5">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="container" style="width: 100%;">
        <a class="navbar-brand" href="#"> <b>Welcome to your dashboard</b></a>
        <p>This is where you can manage your tasks and view important information.</p>
    </div>
    
      <div class="collapse navbar-collapse " id="navbarNav" style="padding-left:55%">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <img src="{% static 'assets/search.png' %}" class="" alt="search">
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <img src="{% static 'assets/message.png' %}" class="" alt="message">
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <img src="{% static 'assets/setting.png' %}" class="" alt="total-users">
                </a>
            </li>
            <li class="nav-item" style="margin-top: 3%; border: none; cursor: pointer;" onmouseover="this.style.backgroundColor='#3180ff';" onmouseout="this.style.backgroundColor='#f3f6fb';">
                {% if request.session.userN %}
                <div class="d-flex align-items-center">
                    <i class="fas fa-user-circle fa-lg"></i>
                    <p class="mb-0 ml-2 px-2" style="font-weight: bold; font-size: large;">{{ request.session.userN }}</p>
                </div>
                {% endif %}
            </li>
        </ul>
        
      </div>
    </div>
  </nav>
<div id="notificationModal" class="modal border" style="display: none; position: absolute; top: 100px; left: 0; height: auto; width: 25rem">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Notification</h5>
                <button type="button" class="btn-close" onclick="hideNotification()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% for chargeback in pending_chargebacks %}
                <h1>Chargeback Details</h1>
                <p>Booking: {{ chargeback.Booking }}</p>
                <p>Booking Confirmation No: {{ chargeback.booking_confirmation_no }}</p>
                <p>Chargeback Amount: {{ chargeback.chargeback_amount }}</p>
                {% endfor %}
            </div>
        </div>
</div>



{% for chargeback in pending_chargebacks %}
<span class="position-relative" style="cursor: pointer" onclick="showNotification('{{ forloop.counter }}')">
    <i class="fas fa-money-bill-alt"></i>
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-light text-dark mt-1">
        {{ forloop.counter }}
    </span>
</span>
{% endfor %}


<!-- Display Chargeback Alerts -->
    <marquee behavior="scroll" direction="left" class="alert alert-warning"{% if pending_chargebacks %} style="display:block;" {% else %} style="display:none;" {% endif %}>
        {% for chargeback in pending_chargebacks %}
           <Strong>Chargeback alert:</strong> {{ chargeback.customer_name }} - ${{ chargeback.chargeback_amount }} | {{ chargeback.chargeback_received_date }}
        {% endfor %}
    </marquee>
    <!-- <h1 class="text-center mt-1 py-2 col-custom-color2">CRM  <span>Dash</span>board</h1> <br> -->
    <div class="container" style="padding-right: 0; padding-left: 0;">
        <div class="row">
            <div class="col-md-3 px-1 mt-md-0">
                <div class="card shadow-lg col-custom-color card-with-background">
                    <div class="card-body">
                        {% if request.user.is_superuser %}
                            <a class="text-decoration-none text-reset" href="{% url 'crmApp:sales' %}">
                        {% endif %}
                        <h5 class="card-text" style="color: #fff; padding-right: 50%;">Total Sales</h5>
                        </a>
                        <h3 style=" padding-right: 70%; padding-top: 15%;"><b>$</b> {{ total_sales }}</h3>
                        <p style=" padding-right: 40%;">Since last Month</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 px-1 mt-md-0 mt-1">
                <div class="card shadow-lg col-custom-color card-with-background3">
                    <div class="card-body">
                        <a class="text-decoration-none text-reset" href="{% url 'crmApp:sales' %}">
                            <h5 class="card-text" style="color: #fff; padding-right: 50%;">Total Leads</h5>
                        </a>
                        <h3 style=" padding-right: 70%; padding-top: 15%;"><b>$</b> {{ total_sales }}</h3>
                        <p style=" padding-right: 40%;">Since last Month</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 px-1 mt-md-0 mt-1">
                <div class="card shadow-lg col-custom-color card-with-background4">
                    <div class="card-body">
                        <a class="text-decoration-none text-reset" href="{% url 'crmApp:sales' %}">
                            <h5 class="card-text" style="color: #fff; padding-right: 50%;">Total Refund</h5>
                        </a>
                        <h3 style=" padding-right: 70%; padding-top: 15%;"><b>$</b> {{ total_sales }}</h3>
                        <p style=" padding-right: 40%;">Since last Month</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 px-1 mt-md-0 mt-1">
                <div class="card shadow-lg col-custom-color card-with-background5">
                    <div class="card-body">
                        <a class="text-decoration-none text-reset" href="{% url 'crmApp:sales' %}">
                            <h5 class="card-text" style="color: #fff; padding-right: 30%;">Total Chargeback</h5>
                        </a>
                        <h3 style=" padding-right: 70%; padding-top: 15%;"><b>$</b> {{ total_sales }}</h3>
                        <p style=" padding-right: 40%;">Since last Month</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Sales Overview</h3>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="salesDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Yearly
                            </button>
                            <div class="dropdown-menu" aria-labelledby="salesDropdown">
                                <a class="dropdown-item" href="#">Yearly</a>
                                <a class="dropdown-item" href="#">Monthly</a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>
            
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>Income</h3>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="incomeDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Yearly
                            </button>
                            <div class="dropdown-menu" aria-labelledby="incomeDropdown">
                                <a class="dropdown-item" href="#">Yearly</a>
                                <a class="dropdown-item" href="#">Monthly</a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <script>
        // Sales Chart Data
        var salesData = {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
            datasets: [{
                label: 'Sales',
                data: [1000, 2000, 1500, 3000, 2500, 1800, 4000],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        };

        // Income Chart Data
        var incomeData = {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
            datasets: [{
                label: 'Income',
                data: [2000, 2500, 1800, 3000, 2000, 1500, 2500],
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        // Render Charts
        var salesCtx = document.getElementById('salesChart').getContext('2d');
        var incomeCtx = document.getElementById('incomeChart').getContext('2d');

        var salesChart = new Chart(salesCtx, {
            type: 'line',
            data: salesData
        });

        var incomeChart = new Chart(incomeCtx, {
            type: 'line',
            data: incomeData
        });
    </script>
     <div class="container mt-5">
        <div class="row">
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Total Sales</h5>
                        <button class="btn btn-sm btn-primary">View All</button>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Agent Name</th>
                                    <th>Total Sales</th>
                                    <th>Refund</th>
                                    <th>Chargeback</th>
                                    <th>Chargeback Alert</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Add your table rows here -->
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <tr>
                                    <td>Agent 1</td>
                                    <td>$1000</td>
                                    <td>$200</td>
                                    <td>$50</td>
                                    <td>No</td>
                                    <td>Active</td>
                                </tr>
                                <!-- Add more rows if needed -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">
                        <h5>Best Performers</h5>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            
                            <tbody>
                                <!-- Add your table rows here -->
                                <tr>
                                    <td>Lwithw Jr Kacy</td>  
                                </tr>
                                <tr>
                                    <td>Timphu Senyung</td>
                                </tr>
                                <tr>
                                    <td>Danswrang Boro</td>
                                </tr>
                                <tr>
                                    <td>Bhaivab Singh</td>
                                </tr>
                                <tr>
                                    <td>Yo Yo Honey Singh</td>
                                </tr>
                                <!-- Add more rows if needed -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container mt-5 mb-5">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3>Income Overview</h3>
                        <div>
                            <button class="btn btn-sm btn-primary mr-2">Annual</button>
                            <button class="btn btn-sm btn-primary mr-2">Monthly</button>
                            <button class="btn btn-sm btn-primary ml-2">View More</button> <!-- Added ml-2 for left margin -->
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="incomeOverviewChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    

    <script>
        // Income Overview Chart Data
        var incomeOverviewData = {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun','Jul', 'Aug', 'Sept', 'Oct','Nov' ,'Dec'],
            datasets: [{
                label: 'Income Overview',
                data: [2000, 2500, 1800, 3000, 2000, 1500],
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        // Render Chart
        var incomeOverviewCtx = document.getElementById('incomeOverviewChart').getContext('2d');

        var incomeOverviewChart = new Chart(incomeOverviewCtx, {
            type: 'bar',
            data: incomeOverviewData,
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    </script>
        <!-- <div class="col-md-3  px-1 mt-md-0 mt-1">
            <div class="card shadow-lg col-custom-color card-with-background1">
                <div class="card-body" style="opacity:0.7; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
            
                    <img src="{% static 'assets/MonthlyIncomeIcon.png' %}" class="income" alt="Income">
            
                    <p class="card-text mt-2 text-light">Monthly Income: <b>$</b> {{ monthly_income }}</p>
            
                </div>
            </div>
            
        </div> -->
        <!-- <div class="col-md-3  px-1 mt-md-0 mt-1">
            <div class="card shadow-lg col-custom-color card-with-background2">
                <div class="card-body">
                    <p class="card-text mt-5 text-light">Annual Income: <b>$</b> {{ annual_income }}</p>
                </div>
            </div>
        </div> -->
        <!-- <div class="col-md-3  px-1 mt-md-0 mt-1">
        <div class="card shadow-lg col-custom-color1 card-with-background7 my-0 py-0">
            <div class="card-header bg-success">
                <h6 class="card-title text-light">Best Performer</h6>
            </div>
            <div class="card-body">
                {% comment %} <p class="card-text "><i class="fas fa-user-circle user-icon" style="opacity:0.7; "></i></i>Danswrang Boro<br>Thimpu Sengyung<br>Bhaibab Chetry<br>Mousomi Kakoti<br>Sanjay Singh</p> {% endcomment %}
                <ul class="px-0">
                    {% for agent in confirm_agentlist %}
                        <li>
                            {% if request.user.is_superuser or request.user.role == 'manager' %}
                                <p class="clickable agent-button" data-username="{{ agent.lead_agent.username }}" style="cursor: pointer">
                            {% endif %}
                                <i class="fas fa-user-circle user-icon" style="opacity:0.7;margin-right:2% "></i> {{ agent.lead_agent.username }}
                            </p>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div> -->
    
    <!-- <div class="row mt-2"> -->
        
       
        
        <!-- {% if request.user.is_superuser or request.user.role == 'manager' %}
            <div class="col-md-3  px-1 mt-md-0 mt-1">
                
                <div class="card mt-2">
                    <div class="card shadow-lg col-custom-color1 card-with-background8">
                    <div class="card-header bg-success">
                        <h6 class="card-title text-light">Performance Activity</h6>
                    </div>
                    <div class="card-body my-0 py-0">
                        <ul class="px-0 mt-2">
                            <li>Total Leads</li>
                            <li>Total Sales:<span id ="t_sales" class="mx-2 text-primary"></span></li>
                            <li>Total Refund</li>
                            <li>Total Chargeback</li>
                            <li>Total Profit</li>
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
    </div> -->
     
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    {% comment %} <script>
        $(document).ready(function() {
            $('.agent-button').click(function(event) {
                event.preventDefault(); // Prevent the default form submission behavior
                var username = $(this).data('username'); // Get the username from the data attribute
                var csrftoken = $('[name=csrfmiddlewaretoken]').val(); // Get the CSRF token from the hidden input field
        
                $.ajax({
                    url: '/get_agent_data/',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken  // Include the CSRF token in the headers
                    },
                    data: {
                        username: username
                    },
                    success: function(response) {
                        console.log('Total Price:', response.total_price);
                        $('#t_sales').text('$ '+response.total_price);
                    },
                    error: function(xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        // Handle error response if needed
                    }
                });
            });
        });        
    </script> {% endcomment %}
    <script>
        $(document).ready(function() {
            // Perform AJAX request when the document is ready
            getAgentData();
    
            $('.agent-button').click(function(event) {
                event.preventDefault(); // Prevent the default form submission behavior
                getAgentData();
            });
    
            function getAgentData() {
                var username = $('.agent-button').data('username'); // Get the username from the data attribute
                var csrftoken = $('[name=csrfmiddlewaretoken]').val(); // Get the CSRF token from the hidden input field
    
                $.ajax({
                    url: '/get_agent_data/',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken  // Include the CSRF token in the headers
                    },
                    data: {
                        username: username
                    },
                    success: function(response) {
                        console.log('Total Price:', response.total_price);
                        $('#t_sales').text('$ ' + response.total_price);
                    },
                    error: function(xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        // Handle error response if needed
                    }
                });
            }
        });        
    </script>
    
    {% comment %} <script>
        // Get all list items with the class "clickable"
        var clickableItems = document.querySelectorAll('.clickable');
    
        // Loop through each clickable item and attach a click event listener
        clickableItems.forEach(function(item) {
            item.addEventListener('click', function() {
                // Log the text content of the clicked list item to the console
                console.log(item.textContent);
            });
        });
    </script> {% endcomment %}
    <script>
        function showNotification(counter) {
            var modal = document.getElementById('notificationModal');
            var notificationContent = document.getElementById('notificationContent');
            
            // Update notification content
            //notificationContent.textContent = 'You clicked on chargeback #' + counter;
        
            // Show the modal by setting its display to 'block'
            modal.style.display = 'block';
            // Adjust modal position relative to the icon
            var iconPosition = document.querySelector('.position-relative').getBoundingClientRect();
            modal.style.top = (iconPosition.bottom + 10) + 'px';
            modal.style.left = (iconPosition.left) + 'px';
        }
        
        function hideNotification() {
            var modal = document.getElementById('notificationModal');
        
            // Hide the modal by setting its display to 'none'
            modal.style.display = 'none';
        }
            
    </script>
    
{% endblock %}
