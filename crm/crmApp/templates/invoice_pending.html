{% extends 'base.html' %}
{% load static %}
{% block content%}
<div class="container mt-4">
    <div class="table-responsive" id="table">
    <h2  style="font-size: 0.8rem">Invoice Details</h2>
      <table class="table table-bordered">
        <thead class="thead-dark" style="font-size: 0.8rem">
          <tr>
            <th>Invoice ID</th>
            <th>Base Price</th>
            <th>Markup Price</th>
            <th>Description 1</th>
            <th>Total 1</th>
            <th>Tax</th>
            <th>Description 2</th>
            <th>Total 2</th>
            <th>Discount</th>
            <th>Total Discount</th>
            <th>Service charges</th>
            <th>Grand Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr  style="font-size: 0.7rem">
            <td class="invoice-id" style="font-weight: bolder; cursor: pointer; background: grey; color: white"><a href= "{% url 'crmApp:view_invoice' pk=invoice.pk %}">{{ invoice.invoice_id }}</a></td>
            <td>{{ invoice.base_price }}</td>
            <td>{{ invoice.markup_price }}</td>
            <td>{{ invoice.description1 }}</td>
            <td>{{ invoice.total1 }}</td>
            <td>{{ invoice.tax }}</td>
            <td>{{ invoice.description2 }}</td>
            <td>{{ invoice.total2 }}</td>
            <td>{{ invoice.discount }}</td>
            <td>{{ invoice.total_discount }}</td>
            <td>{% for charges in invoice.additioncharge_set.all %}
                    {{ charges.description }} {{ charges.price }} <br>
                {% endfor %}
            </td>
            <td>{{ invoice.grand_total }}</td>
            <td>{{ invoice.status }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
  </div>
   
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Retrieve the JSON data from the template context
            var invoicesJson = '{{ invoices_json | escapejs }}';
            var section = document.getElementById("invoice");
            var table = document.getElementById("table");
            // Parse the JSON data into JavaScript objects
            var invoices = JSON.parse(invoicesJson);
            console.log("Invoices:", invoices);
    
            // Function to calculate total price of addition charges
            function calculateAdditionChargesTotal(additionCharges) {
                var totalPrice = 0;
                additionCharges.forEach(function(charge) {
                    totalPrice += parseFloat(charge.price);
                });
                return totalPrice;
            }
    
            // Add click event listener to all elements with class 'invoice-id'
            document.querySelectorAll('.invoice-id').forEach(function(element) {
                element.addEventListener('click', function() {
                    // Extract invoice_id from data attribute
                    var invoiceId = this.getAttribute('data-invoice-id');
                    document.getElementById("id_to_pass").value=invoiceId;
    
                    // Find the invoice object with the clicked ID
                    var clickedInvoice = invoices.find(function(invoice) {
                        return invoice.invoice_id === invoiceId;
                    });
    
                    // Calculate airfare (base price + markup price)
                    var airfarePrice = parseFloat(clickedInvoice.base_price) + parseFloat(clickedInvoice.markup_price);
    
                    // Calculate total price of addition charges
                    var additionChargesTotal = calculateAdditionChargesTotal(clickedInvoice.addition_charges);
    
                    // Calculate total price after discount
                    var totalPriceAfterDiscount = airfarePrice + additionChargesTotal + parseFloat(clickedInvoice.tax) - parseFloat(clickedInvoice.discount);
    
                    // Display airfare and addition charges total in HTML
                    var airfareElement = document.getElementById("airfarecharges");
                    airfareElement.textContent = '$ ' + airfarePrice.toFixed(2);
    
                    var additionChargesTotalElement = document.getElementById("additionChargesTotal");
                    additionChargesTotalElement.textContent = '$ ' + additionChargesTotal.toFixed(2);
    
                    // Display tax in HTML
                    var taxAmountElement = document.getElementById("taxAmount");
                    taxAmountElement.textContent = '$ ' + parseFloat(clickedInvoice.tax).toFixed(2);
    
                    // Display discount or "None" in HTML
                    var discountAmountElement = document.getElementById("discountAmount");
                    if (parseFloat(clickedInvoice.discount) > 0) {
                        discountAmountElement.textContent = '$ ' + parseFloat(clickedInvoice.discount).toFixed(2);
                    } else {
                        discountAmountElement.textContent = 'None';
                    }
    
                    // Display total price after discount in HTML
                    var totalPriceAfterDiscountElement = document.getElementById("totalPriceAfterDiscount");
                    totalPriceAfterDiscountElement.innerHTML = '<b>$' + totalPriceAfterDiscount.toFixed(2) + '</b>';
                    // Display corresponding whole data in console
                    console.log("Clicked Invoice Data:", clickedInvoice);
                    section.style.display = 'block';
                    table.style.display = 'none';
                });
            });
        });
    </script>
    <script>
        // Function to handle form submission
        function submitForm() {
            // Assuming there's some logic here to send the mail
            // For demonstration purposes, let's just log a message
            console.log("Mail sent!");
            document.getElementById("this_form").submit();
            // You can add your AJAX call or any other logic to actually send the mail here
        }
    
        // Attaching the function to the button click event
        document.getElementById("submit_the_form").addEventListener("click", function(event) {
            event.preventDefault(); // Prevent the default form submission behavior
            submitForm(); // Call the function to handle form submission
        });
    </script>
    
{% endblock %}